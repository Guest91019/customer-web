<!-- <!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>2</title>
  <script type="module">
    import { checkAuth, saveOrder, logout } from "./js/app.js";

    checkAuth(user => { if (!user) location.href = "index.html"; });

    document.getElementById("saveBtn").addEventListener("click", () => {
      const name = document.getElementById("name").value;
      const order = document.getElementById("order").value;
      saveOrder(name, order).then(() => alert("บันทึกเรียบร้อย"));
    });

    document.getElementById("logoutBtn").addEventListener("click", () => logout());
  </script>
</head>
<body>
  <h2>ฟอร์มกรอกข้อมูลลูกค้า</h2>
  <input id="name" placeholder="ชื่อลูกค้า">
  <input id="order" placeholder="รายการสั่งซื้อ">
  <button id="saveBtn">บันทึก</button>
  <button id="logoutBtn">ออกจากระบบ</button>
</body>
</html> -->


<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ค้นหาลูกค้า</title>
  <script type="module">
    // ------------------ Firebase Config ------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAjgWD2Px4Fnh5x7dasYBO1uTyMD6HUR0",
  authDomain: "webjj-376d9.firebaseapp.com",
  databaseURL: "https://webjj-376d9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "webjj-376d9",
  storageBucket: "webjj-376d9.appspot.com",
  messagingSenderId: "717462816877",
  appId: "1:717462816877:web:3e1d003f38ab7c70b29764",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ------------------ ฟังก์ชันค้นหา ------------------
    async function searchData() {
      const keyword = document.getElementById("keyword").value.trim().toLowerCase();
      const dateKeyword = document.getElementById("dateKeyword").value.trim();

      const dbRef = ref(db);
      const snapshot = await get(child(dbRef, "customers")); // customers = ชื่อตาราง
      let resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (snapshot.exists()) {
        let customers = snapshot.val();
        

        // filter ข้อมูล
Object.entries(customers).forEach(([custId, cust], index) => {
          let matchKeyword = !keyword || (
            (cust.firstname && cust.firstname.toLowerCase().includes(keyword)) ||
            (cust.lastname && cust.lastname.toLowerCase().includes(keyword)) ||
            (cust.address && cust.address.toLowerCase().includes(keyword))
          );

          let matchDate = !dateKeyword || (cust.date && cust.date.includes(dateKeyword));

          if (matchKeyword && matchDate) {
            resultsDiv.innerHTML += `
              <div style="border:1px solid #ccc; margin:5px; padding:5px;">
                <b>#${index + 1}</b><br>
                ชื่อ: ${cust.firstname} ${cust.lastname}<br>
                ที่อยู่: ${cust.address}<br>
                วันที่: ${cust.date}<br>
                <button onclick="toggleDetail('${custId}')">ดูรายละเอียด</button>
                <div id="detail-${custId}" style="display:none; margin-top:10px; padding:5px; border-top:1px solid #ddd;">
                  ${cust.purchases ? cust.purchases.map(p => `
                    <p>- ${p.item}: ${p.amount} บาท</p>
                  `).join("") : "<p>ไม่มีข้อมูลการซื้อ</p>"}
                </div>
              </div>
            `;
          }
        });
      } else {
        resultsDiv.innerHTML = "<p>ยังไม่มีข้อมูลในระบบ</p>";
      }
    }

    // ------------------ toggle โชว์/ซ่อน ------------------
    window.toggleDetail = function(id) {
      const detailDiv = document.getElementById("detail-" + id);
      if (detailDiv.style.display === "none") {
        detailDiv.style.display = "block";
      } else {
        detailDiv.style.display = "none";
      }
    };

    window.searchData = searchData;
  </script>
</head>
<body>
  <h2>ค้นหาลูกค้า</h2>
  <input type="text" id="keyword" placeholder="พิมพ์ชื่อ / นามสกุล / ที่อยู่">
  <input type="text" id="dateKeyword" placeholder="ค้นหาตามวันที่ (yyyy-mm-dd)">
  <button onclick="searchData()">ค้นหา</button>
  <div id="results" style="margin-top:20px;"></div>
</body>
</html>